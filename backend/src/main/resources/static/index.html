<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Lab Dashboard</title>
    <style>
        :root {
            --bg: #0f1419;
            --card: #1a2332;
            --text: #e6edf3;
            --muted: #8b949e;
            --accent: #58a6ff;
            --ok: #3fb950;
            --warn: #d29922;
            --card-border: rgba(255,255,255,0.06);
            --card-hover: rgba(88,166,255,0.3);
            --modal-overlay: rgba(0,0,0,0.6);
            --font: system-ui, -apple-system, sans-serif;
        }
        /* Matrix – hacker terminal */
        [data-theme="matrix"] {
            --bg: #0a0a0a;
            --card: #0d0d0d;
            --text: #00ff41;
            --muted: #00aa2a;
            --accent: #00ff41;
            --ok: #00ff41;
            --warn: #00ff41;
            --card-border: rgba(0,255,65,0.25);
            --card-hover: rgba(0,255,65,0.4);
            --modal-overlay: rgba(0,0,0,0.85);
            --font: "Consolas", "Monaco", "Courier New", monospace;
        }
        [data-theme="matrix"] body { text-shadow: 0 0 4px var(--text); }
        [data-theme="matrix"] .card { box-shadow: 0 0 12px rgba(0,255,65,0.08); }
        [data-theme="matrix"] .card:hover { box-shadow: 0 0 16px rgba(0,255,65,0.2); }
        [data-theme="matrix"] .status.online { box-shadow: 0 0 6px var(--ok); }
        [data-theme="matrix"] .modal-panel { box-shadow: 0 0 24px rgba(0,255,65,0.15); border-color: var(--card-border); }
        /* Retro Windows 95/XP */
        [data-theme="retro"] {
            --bg: #008080;
            --card: #c0c0c0;
            --text: #000000;
            --muted: #404040;
            --accent: #000080;
            --ok: #008000;
            --warn: #808000;
            --card-border: #ffffff;
            --card-hover: #000080;
            --modal-overlay: rgba(0,0,0,0.5);
            --font: Tahoma, "Segoe UI", Arial, sans-serif;
        }
        [data-theme="retro"] .card {
            border: 2px solid;
            border-color: #dfdfdf #808080 #808080 #dfdfdf;
            border-radius: 0;
            box-shadow: none;
        }
        [data-theme="retro"] .card:hover { border-color: #000080; box-shadow: none; }
        [data-theme="retro"] .card h2 {
            background: linear-gradient(90deg, #000080, #1084d0);
            color: #ffffff;
            margin: -1rem -1rem 0.75rem -1rem;
            padding: 0.25rem 0.5rem;
            font-weight: bold;
        }
        [data-theme="retro"] .modal-panel {
            border: 2px solid;
            border-color: #dfdfdf #808080 #808080 #dfdfdf;
            border-radius: 0;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }
        [data-theme="retro"] .modal-panel h3 {
            background: linear-gradient(90deg, #000080, #1084d0);
            color: #fff;
            margin: -1.25rem -1.25rem 1rem -1.25rem;
            padding: 0.4rem 0.5rem;
            border-radius: 0;
        }
        [data-theme="retro"] .modal-close,
        [data-theme="retro"] .govee-btn {
            border: 2px solid;
            border-color: #dfdfdf #808080 #808080 #dfdfdf;
            background: #c0c0c0;
            color: #000;
            border-radius: 0;
        }
        [data-theme="retro"] .modal-close:hover,
        [data-theme="retro"] .govee-btn:hover {
            background: #d4d4d4;
            border-color: #808080 #dfdfdf #dfdfdf #808080;
        }
        [data-theme="retro"] .modal-close:active,
        [data-theme="retro"] .govee-btn:active {
            border-color: #808080 #dfdfdf #dfdfdf #808080;
            padding: 0.27rem 0.77rem;
        }
        [data-theme="retro"] .modal-panel th { color: #000; }
        [data-theme="retro"] .modal-panel .detail-row span:last-child { color: #000; }
        /* Solarized Dark */
        [data-theme="solarized"] {
            --bg: #002b36;
            --card: #073642;
            --text: #839496;
            --muted: #586e75;
            --accent: #268bd2;
            --ok: #859900;
            --warn: #b58900;
            --card-border: rgba(131,148,150,0.2);
            --card-hover: #268bd2;
            --modal-overlay: rgba(0,43,54,0.9);
            --font: system-ui, sans-serif;
        }
        /* Dracula */
        [data-theme="dracula"] {
            --bg: #282a36;
            --card: #44475a;
            --text: #f8f8f2;
            --muted: #6272a4;
            --accent: #bd93f9;
            --ok: #50fa7b;
            --warn: #f1fa8c;
            --card-border: rgba(98,114,164,0.4);
            --card-hover: #bd93f9;
            --modal-overlay: rgba(40,42,54,0.85);
            --font: system-ui, sans-serif;
        }
        /* Nord */
        [data-theme="nord"] {
            --bg: #2e3440;
            --card: #3b4252;
            --text: #eceff4;
            --muted: #88c0d0;
            --accent: #5e81ac;
            --ok: #a3be8c;
            --warn: #ebcb8b;
            --card-border: rgba(136,192,208,0.25);
            --card-hover: #5e81ac;
            --modal-overlay: rgba(46,52,64,0.9);
            --font: system-ui, sans-serif;
        }
        /* AMOLED */
        [data-theme="amoled"] {
            --bg: #000000;
            --card: #0a0a0a;
            --text: #e0e0e0;
            --muted: #606060;
            --accent: #6c5ce7;
            --ok: #00e676;
            --warn: #ffab00;
            --card-border: rgba(255,255,255,0.06);
            --card-hover: #6c5ce7;
            --modal-overlay: rgba(0,0,0,0.95);
            --font: system-ui, sans-serif;
        }
        /* Light / Paper */
        [data-theme="light"] {
            --bg: #f5f5f0;
            --card: #ffffff;
            --text: #1a1a1a;
            --muted: #666666;
            --accent: #1565c0;
            --ok: #2e7d32;
            --warn: #ef6c00;
            --card-border: rgba(0,0,0,0.1);
            --card-hover: #1565c0;
            --modal-overlay: rgba(0,0,0,0.4);
            --font: system-ui, sans-serif;
        }
        [data-theme="light"] .modal-close { color: #fff; }
        /* High contrast */
        [data-theme="contrast"] {
            --bg: #000000;
            --card: #000000;
            --text: #ffffff;
            --muted: #cccccc;
            --accent: #ffff00;
            --ok: #00ff00;
            --warn: #ff9900;
            --card-border: #ffffff;
            --card-hover: #ffff00;
            --modal-overlay: rgba(0,0,0,0.9);
            --font: system-ui, sans-serif;
        }
        [data-theme="contrast"] .card { border-width: 2px; }
        /* Glass */
        [data-theme="glass"] {
            --bg: #1a1a2e;
            --card: rgba(255,255,255,0.08);
            --text: #eaeaea;
            --muted: #a0a0a0;
            --accent: #7b68ee;
            --ok: #4ade80;
            --warn: #fbbf24;
            --card-border: rgba(255,255,255,0.12);
            --card-hover: rgba(123,104,238,0.5);
            --modal-overlay: rgba(0,0,0,0.5);
            --font: system-ui, sans-serif;
        }
        [data-theme="glass"] .card,
        [data-theme="glass"] .modal-panel { backdrop-filter: blur(12px); }
        [data-theme="glass"] body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); }
        * { box-sizing: border-box; }
        body {
            font-family: var(--font);
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 1rem;
            min-height: 100vh;
        }
        h1 {
            font-size: 1.5rem;
            margin: 0 0 1rem 0;
            color: var(--text);
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        .card {
            background: var(--card);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid var(--card-border);
        }
        .card h2 {
            font-size: 0.875rem;
            margin: 0 0 0.75rem 0;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .card .value { font-size: 1.5rem; font-weight: 600; color: var(--accent); }
        .card .row { display: flex; justify-content: space-between; margin: 0.25rem 0; }
        .card .row span:last-child { color: var(--muted); }
        .status { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 0.5rem; }
        .status.online { background: var(--ok); }
        .status.offline { background: var(--muted); }
        .error { color: #f85149; font-size: 0.875rem; }
        .updated { color: var(--muted); font-size: 0.75rem; margin-top: 0.5rem; }
        .card { cursor: pointer; transition: border-color 0.15s, box-shadow 0.15s; }
        .card:hover { border-color: var(--card-hover); box-shadow: 0 0 0 1px var(--card-hover); }
        .card .hint { font-size: 0.7rem; color: var(--muted); margin-top: 0.5rem; }
        .modal-overlay {
            display: none; position: fixed; inset: 0; background: var(--modal-overlay); z-index: 100;
            align-items: center; justify-content: center; padding: 1rem;
        }
        .modal-overlay.open { display: flex; }
        .modal-panel {
            background: var(--card); border: 1px solid var(--card-border); border-radius: 12px;
            max-width: 480px; width: 100%; max-height: 85vh; overflow: auto;
            padding: 1.25rem; box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        .modal-panel.wide { max-width: min(95vw, 1100px); min-width: 800px; max-height: 90vh; }
        .modal-panel h3 { margin: 0 0 1rem 0; color: var(--accent); font-size: 1.1rem; }
        .modal-panel .detail-row { display: flex; justify-content: space-between; padding: 0.35rem 0; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .modal-panel .detail-row span:last-child { color: var(--muted); }
        .modal-panel table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .modal-panel th, .modal-panel td { text-align: left; padding: 0.4rem 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .modal-panel th { color: var(--muted); font-weight: 500; }
        .modal-close { margin-top: 1rem; padding: 0.4rem 0.8rem; background: var(--muted); border: none; border-radius: 6px; color: var(--bg); cursor: pointer; font-size: 0.875rem; }
        .modal-close:hover { background: var(--text); }
        .govee-btn { padding: 0.25rem 0.5rem; margin: 0 0.15rem; border-radius: 4px; border: 1px solid var(--muted); background: rgba(255,255,255,0.06); color: var(--text); cursor: pointer; font-size: 0.8rem; }
        .govee-btn:hover { border-color: var(--accent); background: rgba(88,166,255,0.15); }
        .page-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
        .theme-switcher { display: flex; gap: 0.25rem; }
        .theme-btn {
            padding: 0.35rem 0.75rem; font-size: 0.8rem; border-radius: 6px;
            border: 1px solid var(--card-border); background: var(--card); color: var(--text);
            cursor: pointer; font-family: var(--font);
        }
        .theme-btn:hover { border-color: var(--accent); }
        .theme-btn.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
        [data-theme="retro"] .theme-btn {
            border: 2px solid; border-color: #dfdfdf #808080 #808080 #dfdfdf;
            background: #c0c0c0; color: #000;
        }
        [data-theme="retro"] .theme-btn.active { background: #000080; color: #fff; border-color: #000080; }
        [data-theme="retro"] .theme-btn:hover:not(.active) { background: #d4d4d4; }
        /* Themed scrollbars */
        .modal-panel::-webkit-scrollbar { width: 10px; height: 10px; }
        .modal-panel::-webkit-scrollbar-track { background: var(--bg); }
        .modal-panel::-webkit-scrollbar-thumb { background: var(--muted); border-radius: 5px; }
        .modal-panel::-webkit-scrollbar-thumb:hover { background: var(--accent); }
        * { scrollbar-width: thin; scrollbar-color: var(--muted) var(--bg); }
        /* Layout density */
        body.density-compact .grid { gap: 0.5rem; }
        body.density-compact .card { padding: 0.6rem; }
        body.density-compact .card h2 { font-size: 0.75rem; margin-bottom: 0.5rem; }
        body.density-compact .card .value { font-size: 1.2rem; }
        body.density-spacious .grid { gap: 1.5rem; }
        body.density-spacious .card { padding: 1.5rem; }
        body.density-spacious .card .value { font-size: 1.75rem; }
        /* Card hidden by visibility toggle */
        .card.hidden { display: none !important; }
        /* Animations */
        .card { animation: cardFadeIn 0.4s ease-out; }
        .card.updated-pulse { animation: pulse 0.5s ease-out; }
        @keyframes cardFadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @media (prefers-reduced-motion: reduce) {
            .card { animation: none; }
            .card.updated-pulse { animation: none; }
        }
        /* Controls row */
        .controls-row { display: flex; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
        .controls-row label { display: flex; align-items: center; gap: 0.35rem; font-size: 0.85rem; color: var(--muted); }
        .controls-row select {
            padding: 0.35rem 0.6rem; font-size: 0.8rem; border-radius: 6px;
            border: 1px solid var(--card-border); background: var(--card); color: var(--text); font-family: var(--font);
        }
        .controls-row .card-toggle { font-size: 0.75rem; color: var(--muted); cursor: pointer; }
        .controls-row .card-toggle:hover { color: var(--accent); }
        .card-visibility-popover {
            position: absolute; top: 100%; right: 0; margin-top: 0.25rem; min-width: 140px;
            background: var(--card); border: 1px solid var(--card-border); border-radius: 8px;
            padding: 0.5rem 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 50; font-size: 0.8rem;
        }
        .card-visibility-popover label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.2rem 0; }
        .page-header { position: relative; }
        .govee-view-toggle { font-size: 0.8rem; margin-bottom: 0.5rem; }
        .govee-view-toggle button { padding: 0.2rem 0.5rem; margin-right: 0.25rem; border-radius: 4px; border: 1px solid var(--card-border); background: var(--card); color: var(--text); cursor: pointer; }
        .govee-view-toggle button.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
        .govee-compact-row { display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.06); flex-wrap: wrap; }
        .govee-compact-row span:last-child { display: flex; align-items: center; flex-wrap: wrap; gap: 0.25rem; }
    </style>
</head>
<body>
    <header class="page-header">
        <h1>Home Lab Dashboard <span class="updated refresh-hint" style="font-size: 0.7rem; font-weight: normal;">(refreshes every 5s)</span></h1>
        <div class="controls-row">
            <label>Theme <select id="theme-select" aria-label="Theme">
                <option value="default">Default</option>
                <option value="matrix">Matrix</option>
                <option value="retro">Retro</option>
                <option value="solarized">Solarized</option>
                <option value="dracula">Dracula</option>
                <option value="nord">Nord</option>
                <option value="amoled">AMOLED</option>
                <option value="light">Light</option>
                <option value="contrast">High contrast</option>
                <option value="glass">Glass</option>
                <option value="system">System</option>
            </select></label>
            <label>Refresh <select id="refresh-select" aria-label="Refresh interval">
                <option value="5">5s</option>
                <option value="15">15s</option>
                <option value="30">30s</option>
                <option value="60">1 min</option>
                <option value="0">Pause</option>
            </select></label>
            <label>Layout <select id="density-select" aria-label="Layout density">
                <option value="comfortable">Comfortable</option>
                <option value="compact">Compact</option>
                <option value="spacious">Spacious</option>
            </select></label>
            <span class="card-toggle-wrap" style="position: relative;">
                <span class="card-toggle" id="card-toggle" title="Show/hide cards">Cards</span>
                <div id="card-visibility-popover" class="card-visibility-popover" style="display: none;">
        <label><input type="checkbox" data-card="server-stats-card" checked> Server</label>
        <label><input type="checkbox" data-card="desktop-stats-card" checked> Desktop</label>
        <label><input type="checkbox" data-card="devices-card" checked> Devices</label>
        <label><input type="checkbox" data-card="speed-test-card" checked> Speed test</label>
        <label><input type="checkbox" data-card="govee-devices-card" checked> Govee</label>
                </div>
            </span>
        </div>
    </header>
    <div class="grid" id="dashboard">
        <div class="card" id="server-stats-card" data-panel="server" title="Click for more">
            <h2>Server stats</h2>
            <div id="server-stats">Loading…</div>
            <div class="hint">Click for more</div>
        </div>
        <div class="card" id="desktop-stats-card" data-panel="desktop" title="Click for more">
            <h2>Desktop (Bazzite)</h2>
            <div id="desktop-stats">Loading…</div>
            <div class="hint">Click for more</div>
        </div>
        <div class="card" id="devices-card" data-panel="devices" title="Click for more">
            <h2>Devices</h2>
            <div id="devices">Loading…</div>
            <div class="hint">Click for more</div>
        </div>
        <div class="card" id="speed-test-card" data-panel="speed" title="Click for more">
            <h2>Speed test</h2>
            <div id="speed-test">Loading…</div>
            <div class="hint">Click for more</div>
        </div>
        <div class="card" id="govee-devices-card" data-panel="govee" title="Click for more">
            <h2>Govee</h2>
            <div id="govee-devices">Loading…</div>
            <div class="hint">Click for more</div>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal-panel" id="modal-panel" onclick="event.stopPropagation()">
            <h3 id="modal-title">Details</h3>
            <div id="modal-body"></div>
            <button class="modal-close" id="modal-close">Close</button>
        </div>
    </div>

    <script>
        const API = ''; // same origin
        const THEME_KEY = 'homelab-theme';
        const REFRESH_KEY = 'homelab-refresh';
        const DENSITY_KEY = 'homelab-density';
        const CARDS_KEY = 'homelab-visible-cards';
        const GOVEE_VIEW_KEY = 'homelab-govee-view';

        const THEMES = ['default','matrix','retro','solarized','dracula','nord','amoled','light','contrast','glass','system'];
        const PANELS = ['server','desktop','devices','speed','govee'];

        function resolveTheme(theme) {
            if (theme !== 'system') return theme;
            return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'default' : 'light';
        }
        function applyTheme(theme) {
            theme = theme || 'default';
            const resolved = resolveTheme(theme);
            document.documentElement.setAttribute('data-theme', resolved);
            const sel = document.getElementById('theme-select');
            if (sel) sel.value = theme;
            try { localStorage.setItem(THEME_KEY, theme); } catch (e) {}
        }
        function initTheme() {
            let theme = 'default';
            try { theme = localStorage.getItem(THEME_KEY) || 'default'; } catch (e) {}
            applyTheme(theme);
        }
        initTheme();
        document.getElementById('theme-select').addEventListener('change', function() { applyTheme(this.value); });
        if (window.matchMedia) window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => { if (document.getElementById('theme-select').value === 'system') applyTheme('system'); });

        async function fetchJson(path) {
            const r = await fetch(API + path);
            if (!r.ok) throw new Error(r.statusText);
            return r.json();
        }

        function n(v) { return v != null ? v : '—'; }

        function renderServerStats(data) {
            const uptimeSec = data.uptime_seconds != null ? data.uptime_seconds : 0;
            const uptimeDays = Math.floor(Number(uptimeSec) / 86400);
            return `
                <div class="value">${n(data.hostname)}</div>
                <div class="row"><span>CPU</span><span>${n(data.cpu_percent)}%</span></div>
                <div class="row"><span>Memory</span><span>${n(data.memory_percent)}%</span></div>
                <div class="row"><span>Disk</span><span>${n(data.disk_used_percent)}%</span></div>
                <div class="row"><span>Uptime</span><span>${uptimeDays}d</span></div>
                <div class="updated">Updated ${new Date(data.timestamp || Date.now()).toLocaleTimeString()}</div>
            `;
        }

        function renderDesktopStats(data) {
            const gpu = data.gpu_util_percent != null ? data.gpu_util_percent + '%' : '—';
            const activity = data.current_activity || '—';
            return `
                <div class="value">${n(data.hostname)}</div>
                <div class="row"><span>CPU</span><span>${n(data.cpu_percent)}%</span></div>
                <div class="row"><span>Memory</span><span>${n(data.memory_percent)}%</span></div>
                <div class="row"><span>GPU</span><span>${gpu}</span></div>
                <div class="row"><span>Activity</span><span>${activity}</span></div>
                <div class="updated">Updated ${new Date(data.timestamp || Date.now()).toLocaleTimeString()}</div>
            `;
        }

        function renderDevices(data) {
            const list = data.devices.map(d =>
                `<div class="row"><span><span class="status ${d.status}"></span>${d.name}</span><span>${d.ip}</span></div>`
            ).join('');
            return list + `<div class="updated">${data.total} devices · ${new Date(data.timestamp).toLocaleTimeString()}</div>`;
        }

        function renderSpeedTest(data) {
            return `
                <div class="row"><span>Download</span><span class="value">${data.download_mbps} Mbps</span></div>
                <div class="row"><span>Upload</span><span class="value">${data.upload_mbps} Mbps</span></div>
                <div class="row"><span>Ping</span><span>${data.ping_ms} ms</span></div>
                <div class="updated">${new Date(data.timestamp).toLocaleTimeString()}</div>
            `;
        }

        function renderGovee(data) {
            const list = (data.devices || []).map(d =>
                `<div class="row"><span>${d.name}</span><span>${d.model} · ${d.type}</span></div>`
            ).join('');
            return list + `<div class="updated">${data.total ?? 0} devices · ${new Date(data.timestamp || 0).toLocaleTimeString()}</div>`;
        }

        let lastData = { server: null, desktop: null, devices: null, speed: null, govee: null };

        function openDetail(panel) {
            const modal = document.getElementById('modal');
            const panelEl = document.getElementById('modal-panel');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            panelEl.classList.toggle('wide', panel === 'govee');
            const d = lastData[panel];
            if (!d) { body.innerHTML = '<p class="error">No data yet.</p>'; modal.classList.add('open'); return; }
            if (d.error) { body.innerHTML = '<p class="error">' + (d.message || 'Live data unavailable') + '</p>'; modal.classList.add('open'); return; }
            if (panel === 'server') {
                const uptimeSec = d.uptime_seconds != null ? d.uptime_seconds : 0;
                const days = Math.floor(Number(uptimeSec) / 86400);
                const hours = Math.floor((uptimeSec % 86400) / 3600);
                const sec = d.security || {};
                const hasSecurity = sec.failed_ssh_logins_24h != null || sec.ufw_status || sec.updates_pending != null ||
                    (sec.listening_ports && sec.listening_ports.length) || (sec.fail2ban && sec.fail2ban.jails && sec.fail2ban.jails.length) ||
                    sec.unattended_upgrades || sec.apparmor;
                let securityHtml = '';
                if (hasSecurity) {
                    securityHtml = '<h4 style="margin:1rem 0 0.5rem 0; color: var(--muted); font-size: 0.8rem;">Security</h4>';
                    if (sec.failed_ssh_logins_24h != null) securityHtml += `<div class="detail-row"><span>Failed SSH logins (24h)</span><span>${sec.failed_ssh_logins_24h}</span></div>`;
                    if (sec.ufw_status) securityHtml += `<div class="detail-row"><span>UFW</span><span>${sec.ufw_status}</span></div>`;
                    if (sec.fail2ban && sec.fail2ban.jails && sec.fail2ban.jails.length) {
                        securityHtml += '<div class="detail-row"><span>Fail2ban</span><span>' + (sec.fail2ban.status || 'active') + '</span></div>';
                        securityHtml += '<table style="margin-top:0.25rem; font-size:0.85rem;"><thead><tr><th>Jail</th><th>Banned</th><th>Total banned</th><th>Currently failed</th></tr></thead><tbody>';
                        sec.fail2ban.jails.forEach(j => {
                            securityHtml += '<tr><td>' + (j.name || '—') + '</td><td>' + (j.currently_banned != null ? j.currently_banned : '—') + '</td><td>' + (j.total_banned != null ? j.total_banned : '—') + '</td><td>' + (j.currently_failed != null ? j.currently_failed : '—') + '</td></tr>';
                        });
                        securityHtml += '</tbody></table>';
                    }
                    if (sec.unattended_upgrades) {
                        const uu = sec.unattended_upgrades;
                        let uuStr = uu.installed ? 'installed' : '';
                        if (uu.last_run_ts) uuStr += (uuStr ? ' · last run ' : '') + new Date(uu.last_run_ts).toLocaleString();
                        securityHtml += '<div class="detail-row"><span>Unattended-upgrades</span><span>' + (uuStr || '—') + '</span></div>';
                    }
                    if (sec.apparmor) {
                        const aa = sec.apparmor;
                        let aaStr = aa.loaded ? 'loaded' : '';
                        if (aa.profiles_enforce != null) aaStr += (aaStr ? ', ' : '') + aa.profiles_enforce + ' enforcing';
                        if (aa.profiles_loaded != null) aaStr += (aaStr ? ', ' : '') + aa.profiles_loaded + ' profiles';
                        securityHtml += '<div class="detail-row"><span>AppArmor</span><span>' + (aaStr || '—') + '</span></div>';
                    }
                    if (sec.updates_pending != null) securityHtml += `<div class="detail-row"><span>Updates pending</span><span>${sec.updates_pending}${sec.security_updates_pending != null ? ' (' + sec.security_updates_pending + ' security)' : ''}</span></div>`;
                    if (sec.listening_ports && sec.listening_ports.length) {
                        securityHtml += '<table style="margin-top:0.5rem; font-size:0.85rem;"><thead><tr><th>Port</th><th>Process</th></tr></thead><tbody>';
                        sec.listening_ports.slice(0, 25).forEach(p => { securityHtml += `<tr><td>${p.port}</td><td>${p.process || '—'}</td></tr>`; });
                        if (sec.listening_ports.length > 25) securityHtml += `<tr><td colspan="2" style="color: var(--muted);">+ ${sec.listening_ports.length - 25} more</td></tr>`;
                        securityHtml += '</tbody></table>';
                    }
                }
                title.textContent = 'Server – details';
                body.innerHTML = `
                    <div class="detail-row"><span>Hostname</span><span>${n(d.hostname)}</span></div>
                    <div class="detail-row"><span>CPU</span><span>${n(d.cpu_percent)}%</span></div>
                    <div class="detail-row"><span>Memory</span><span>${n(d.memory_percent)}%</span></div>
                    <div class="detail-row"><span>Disk used</span><span>${n(d.disk_used_percent)}%</span></div>
                    <div class="detail-row"><span>Uptime</span><span>${days}d ${hours}h</span></div>
                    <div class="detail-row"><span>Last updated</span><span>${new Date(d.timestamp || 0).toLocaleString()}</span></div>
                    ${securityHtml}
                `;
            } else if (panel === 'desktop') {
                title.textContent = 'Desktop (Bazzite) – details';
                body.innerHTML = `
                    <div class="detail-row"><span>Hostname</span><span>${n(d.hostname)}</span></div>
                    <div class="detail-row"><span>CPU</span><span>${n(d.cpu_percent)}%</span></div>
                    <div class="detail-row"><span>Memory</span><span>${n(d.memory_percent)}%</span></div>
                    <div class="detail-row"><span>GPU utilisation</span><span>${d.gpu_util_percent != null ? d.gpu_util_percent + '%' : '—'}</span></div>
                    <div class="detail-row"><span>Current activity</span><span>${n(d.current_activity)}</span></div>
                    <div class="detail-row"><span>Last updated</span><span>${new Date(d.timestamp || 0).toLocaleString()}</span></div>
                `;
            } else if (panel === 'devices') {
                title.textContent = 'Devices – ' + (d.total || 0) + ' total';
                body.innerHTML = `
                    <table>
                        <thead><tr><th>Name</th><th>IP</th><th>MAC</th><th>Status</th></tr></thead>
                        <tbody>
                            ${(d.devices || []).map(dev => '<tr><td>' + dev.name + '</td><td>' + dev.ip + '</td><td>' + (dev.mac || '—') + '</td><td><span class="status ' + dev.status + '"></span>' + dev.status + '</td></tr>').join('')}
                        </tbody>
                    </table>
                    <div class="detail-row" style="margin-top:0.5rem"><span>Last updated</span><span>${new Date(d.timestamp || 0).toLocaleString()}</span></div>
                `;
            } else if (panel === 'speed') {
                title.textContent = 'Speed test – details';
                body.innerHTML = `
                    <div class="detail-row"><span>Download</span><span>${n(d.download_mbps)} Mbps</span></div>
                    <div class="detail-row"><span>Upload</span><span>${n(d.upload_mbps)} Mbps</span></div>
                    <div class="detail-row"><span>Ping</span><span>${n(d.ping_ms)} ms</span></div>
                    <div class="detail-row"><span>Last run</span><span>${new Date(d.timestamp || 0).toLocaleString()}</span></div>
                `;
            } else if (panel === 'govee') {
                title.textContent = 'Govee – ' + (d.total ?? 0) + ' devices';
                const escapeAttr = (s) => (s == null ? '' : String(s)).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;');
                let goveeView = 'full';
                try { goveeView = localStorage.getItem(GOVEE_VIEW_KEY) || 'full'; } catch (e) {}
                const isCompact = goveeView === 'compact';
                const viewToggle = '<div class="govee-view-toggle"><button type="button" class="govee-view-btn' + (isCompact ? '' : ' active') + '" data-view="full">Full</button><button type="button" class="govee-view-btn' + (isCompact ? ' active' : '') + '" data-view="compact">Compact</button></div>';
                const devices = d.devices || [];
                const compactHtml = devices.map(dev => {
                    const deviceId = escapeAttr(dev.device);
                    const modelId = escapeAttr(dev.model);
                    const canControl = dev.controllable && dev.type !== 'lan';
                    const ctrls = canControl
                        ? '<button type="button" class="govee-btn govee-on" data-device="' + deviceId + '" data-model="' + modelId + '">On</button><button type="button" class="govee-btn govee-off" data-device="' + deviceId + '" data-model="' + modelId + '">Off</button> '
                        + '<input type="range" min="0" max="100" value="50" class="govee-brightness" data-device="' + deviceId + '" data-model="' + modelId + '" style="width:60px;vertical-align:middle"> '
                        + '<button type="button" class="govee-btn govee-color" data-device="' + deviceId + '" data-model="' + modelId + '" data-r="255" data-g="255" data-b="255">W</button>'
                        + '<button type="button" class="govee-btn govee-color" data-device="' + deviceId + '" data-model="' + modelId + '" data-r="255" data-g="0" data-b="0">R</button>'
                        + '<button type="button" class="govee-btn govee-color" data-device="' + deviceId + '" data-model="' + modelId + '" data-r="0" data-g="255" data-b="0">G</button>'
                        + '<button type="button" class="govee-btn govee-color" data-device="' + deviceId + '" data-model="' + modelId + '" data-r="0" data-g="0" data-b="255">B</button> '
                        + '<button type="button" class="govee-btn govee-temp" data-device="' + deviceId + '" data-model="' + modelId + '" data-k="2700">Warm</button>'
                        + '<button type="button" class="govee-btn govee-temp" data-device="' + deviceId + '" data-model="' + modelId + '" data-k="4000">Neutral</button>'
                        + '<button type="button" class="govee-btn govee-temp" data-device="' + deviceId + '" data-model="' + modelId + '" data-k="6500">Cool</button>'
                        : '—';
                    return '<div class="govee-compact-row"><span><strong>' + (dev.name || '—') + '</strong> ' + (dev.model || '') + '</span><span>' + ctrls + '</span></div>';
                }).join('');
                const detailRow = '<div class="detail-row" style="margin-top:0.5rem"><span>Last updated</span><span>' + new Date(d.timestamp || 0).toLocaleString() + '</span></div>';
                body.innerHTML = viewToggle + (isCompact
                    ? '<div class="govee-compact">' + compactHtml + '</div>' + detailRow
                    : `
                    <table>
                        <thead><tr><th>Name</th><th>Model</th><th>Type</th><th>IP</th><th>Controllable</th><th>On/Off</th><th>Brightness</th><th>Color</th><th>Temp</th></tr></thead>
                        <tbody>
                            ${(d.devices || []).map(dev => {
                                const deviceId = escapeAttr(dev.device);
                                const modelId = escapeAttr(dev.model);
                                const canControl = dev.controllable && dev.type !== 'lan';
                                const onOff = canControl
                                    ? '<button type="button" class="govee-btn govee-on" data-device="' + deviceId + '" data-model="' + modelId + '">On</button><button type="button" class="govee-btn govee-off" data-device="' + deviceId + '" data-model="' + modelId + '">Off</button>'
                                    : '—';
                                const brightness = canControl ? '<input type="range" min="0" max="100" value="50" class="govee-brightness" data-device="' + deviceId + '" data-model="' + modelId + '" title="Brightness">' : '—';
                                const color = canControl
                                    ? '<button type="button" class="govee-btn govee-color" data-device="' + deviceId + '" data-model="' + modelId + '" data-r="255" data-g="255" data-b="255" title="White">W</button>'
                                    + '<button type="button" class="govee-btn govee-color" data-device="' + deviceId + '" data-model="' + modelId + '" data-r="255" data-g="0" data-b="0" title="Red">R</button>'
                                    + '<button type="button" class="govee-btn govee-color" data-device="' + deviceId + '" data-model="' + modelId + '" data-r="0" data-g="255" data-b="0" title="Green">G</button>'
                                    + '<button type="button" class="govee-btn govee-color" data-device="' + deviceId + '" data-model="' + modelId + '" data-r="0" data-g="0" data-b="255" title="Blue">B</button>'
                                    : '—';
                                const temp = canControl
                                    ? '<button type="button" class="govee-btn govee-temp" data-device="' + deviceId + '" data-model="' + modelId + '" data-k="2700">Warm</button>'
                                    + '<button type="button" class="govee-btn govee-temp" data-device="' + deviceId + '" data-model="' + modelId + '" data-k="4000">Neutral</button>'
                                    + '<button type="button" class="govee-btn govee-temp" data-device="' + deviceId + '" data-model="' + modelId + '" data-k="6500">Cool</button>'
                                    : '—';
                                return '<tr><td>' + (dev.name || '—') + '</td><td>' + (dev.model || '—') + '</td><td>' + (dev.type || '—') + '</td><td>' + (dev.ip || '—') + '</td><td>' + (dev.controllable ? 'Yes' : 'No') + '</td><td>' + onOff + '</td><td>' + brightness + '</td><td>' + color + '</td><td>' + temp + '</td></tr>';
                            }).join('')}
                        </tbody>
                    </table>
                    <div class="detail-row" style="margin-top:0.5rem"><span>Last updated</span><span>${new Date(d.timestamp || 0).toLocaleString()}</span></div>
                `);
                body.querySelectorAll('.govee-view-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        try { localStorage.setItem(GOVEE_VIEW_KEY, this.dataset.view); } catch (e) {}
                        openDetail('govee');
                    });
                });
                body.querySelectorAll('.govee-on').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); goveeControl(btn.dataset.device, btn.dataset.model, 'turn', 'on'); }));
                body.querySelectorAll('.govee-off').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); goveeControl(btn.dataset.device, btn.dataset.model, 'turn', 'off'); }));
                body.querySelectorAll('.govee-brightness').forEach(inp => inp.addEventListener('change', (e) => { e.stopPropagation(); goveeControl(inp.dataset.device, inp.dataset.model, 'brightness', parseInt(inp.value, 10)); }));
                body.querySelectorAll('.govee-color').forEach(btn => btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    goveeControl(btn.dataset.device, btn.dataset.model, 'color', { r: parseInt(btn.dataset.r, 10), g: parseInt(btn.dataset.g, 10), b: parseInt(btn.dataset.b, 10) });
                }));
                body.querySelectorAll('.govee-temp').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); goveeControl(btn.dataset.device, btn.dataset.model, 'colorTem', parseInt(btn.dataset.k, 10)); }));
            }
            modal.classList.add('open');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('open');
        }

        async function goveeControl(device, model, name, value) {
            if (!device || !model) return;
            try {
                const r = await fetch(API + '/api/govee-devices/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device, model, cmd: { name, value } })
                });
                const data = await r.json();
                if (data.error) {
                    alert(data.message || 'Control failed');
                } else {
                    loadOne('/api/govee-devices', 'govee', renderGovee);
                }
            } catch (e) {
                alert(e.message || 'Request failed');
            }
        }

        const cardIds = { server: 'server-stats', desktop: 'desktop-stats', devices: 'devices', speed: 'speed-test', govee: 'govee-devices' };
        const cardIdToPanel = { 'server-stats-card': 'server', 'desktop-stats-card': 'desktop', 'devices-card': 'devices', 'speed-test-card': 'speed', 'govee-devices-card': 'govee' };
        let refreshTimer = null;

        function getRefreshMs() {
            let v = 5;
            try { v = parseInt(localStorage.getItem(REFRESH_KEY) || '5', 10); } catch (e) {}
            return v === 0 ? 0 : Math.max(5000, v * 1000);
        }
        function applyRefreshInterval() {
            const ms = getRefreshMs();
            document.getElementById('refresh-select').value = ms === 0 ? '0' : String(ms / 1000);
            const hint = document.querySelector('.refresh-hint');
            if (hint) hint.textContent = ms ? '(refreshes every ' + (ms / 1000) + 's)' : '(paused)';
            if (refreshTimer) clearInterval(refreshTimer);
            if (ms) refreshTimer = setInterval(load, ms);
        }
        document.getElementById('refresh-select').addEventListener('change', function() {
            const v = parseInt(this.value, 10);
            try { localStorage.setItem(REFRESH_KEY, String(v)); } catch (e) {}
            applyRefreshInterval();
        });
        (function initRefresh() { applyRefreshInterval(); })();

        function applyDensity() {
            let d = 'comfortable';
            try { d = localStorage.getItem(DENSITY_KEY) || 'comfortable'; } catch (e) {}
            document.body.classList.remove('density-compact', 'density-comfortable', 'density-spacious');
            document.body.classList.add('density-' + d);
            document.getElementById('density-select').value = d;
        }
        document.getElementById('density-select').addEventListener('change', function() {
            try { localStorage.setItem(DENSITY_KEY, this.value); } catch (e) {}
            applyDensity();
        });
        applyDensity();

        function applyCardVisibility() {
            let visible = [];
            try { visible = JSON.parse(localStorage.getItem(CARDS_KEY) || '["server-stats-card","desktop-stats-card","devices-card","speed-test-card","govee-devices-card"]'); } catch (e) {}
            const all = ['server-stats-card','desktop-stats-card','devices-card','speed-test-card','govee-devices-card'];
            all.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.toggle('hidden', !visible.includes(id));
            });
            document.querySelectorAll('#card-visibility-popover input').forEach(cb => {
                cb.checked = visible.includes(cb.dataset.card);
            });
        }
        document.getElementById('card-toggle').addEventListener('click', function(e) {
            const pop = document.getElementById('card-visibility-popover');
            pop.style.display = pop.style.display === 'none' ? 'block' : 'none';
            e.stopPropagation();
        });
        document.addEventListener('click', () => { document.getElementById('card-visibility-popover').style.display = 'none'; });
        document.getElementById('card-visibility-popover').addEventListener('click', e => e.stopPropagation());
        document.querySelectorAll('#card-visibility-popover input').forEach(cb => {
            cb.addEventListener('change', function() {
                let visible = [];
                document.querySelectorAll('#card-visibility-popover input:checked').forEach(c => visible.push(c.dataset.card));
                try { localStorage.setItem(CARDS_KEY, JSON.stringify(visible)); } catch (e) {}
                applyCardVisibility();
            });
        });
        applyCardVisibility();

        async function loadOne(path, key, render) {
            try {
                const data = await fetchJson(path);
                lastData[key] = data;
                const panelId = key === 'server' ? 'server-stats' : key === 'desktop' ? 'desktop-stats' : key === 'speed' ? 'speed-test' : key;
                const target = document.getElementById(cardIds[key]);
                if (!target) return;
                if (data && data.error) {
                    target.innerHTML = '<span class="error">' + (data.message || 'Live data unavailable') + '</span>';
                } else {
                    target.innerHTML = render(data);
                    target.classList.add('updated-pulse');
                    setTimeout(() => target.classList.remove('updated-pulse'), 500);
                }
            } catch (e) {
                lastData[key] = null;
                const target = document.getElementById(cardIds[key]);
                if (target) target.innerHTML = '<span class="error">' + e.message + '</span>';
            }
        }
        async function load() {
            await Promise.all([
                loadOne('/api/server-stats', 'server', renderServerStats),
                loadOne('/api/desktop-stats', 'desktop', renderDesktopStats),
                loadOne('/api/devices', 'devices', renderDevices),
                loadOne('/api/speed-test', 'speed', renderSpeedTest),
                loadOne('/api/govee-devices', 'govee', renderGovee)
            ]);
            updateTabStatus();
        }

        function updateTabStatus() {
            let issues = 0;
            if (lastData.server && lastData.server.error) issues++;
            if (lastData.desktop && lastData.desktop.error) issues++;
            if (lastData.devices && lastData.devices.error) issues++;
            if (lastData.govee && lastData.govee.error) issues++;
            document.title = issues ? 'Home Lab (' + issues + ' issue' + (issues > 1 ? 's' : '') + ')' : 'Home Lab Dashboard';
        }

        load();

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') { closeModal(); return; }
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
            if (e.key === 't' || e.key === 'T') {
                const sel = document.getElementById('theme-select');
                const i = THEMES.indexOf(sel.value);
                applyTheme(THEMES[(i + 1) % THEMES.length]);
                return;
            }
            const n = parseInt(e.key, 10);
            if (n >= 1 && n <= 5) {
                openDetail(PANELS[n - 1]);
            }
        });

        document.querySelectorAll('.card[data-panel]').forEach(card => {
            card.addEventListener('click', () => openDetail(card.getAttribute('data-panel')));
        });
        document.getElementById('modal-close').addEventListener('click', closeModal);
        document.getElementById('modal').addEventListener('click', closeModal);
    </script>
</body>
</html>
